# offline-pack-server

离线包系统，使用nodejs开发

### 介绍

支持bsdiff 进行差分， 有一个还算可以看的管理界面。 后台使用 node搭建，比较简单。

开发的主要原因是为了支持我的 [axe](https://github.com/CodingForMoney/axe) , 所以这个离线包系统属于 `axe`系统中的一部分，附赠内容。

### 安装使用

安装

    npm install offline-pack-server -g      

使用， 在一个文件夹下，或者指定一个文件夹 ，启动服务 ：

    offline-pack-server helloworld

然后在 `helloworld`文件夹下，有一个`config.js`， 可以进行一些定制。 

### 包的保存

包的保存目前支持两种。

一种是保存在本地文件中， 使用`nginx`或者`offline-pack-server` 来分发资源。默认配置就是这样，可以查看配置文件了解详情。

一种是上传到阿里云的oss中，详情查看配置文件。

### 安全性的讨论

当前管理页面和`app`的请求是放在一起的， 那如何隐藏管理页面呢 ？

我的建议是，在`node`前面还是要有一层`nginx`来控制与转发。 对于管理页面的路径与请求，限定ip，以做到内网才能访问。

## 注意事项 

包内不要有中文路径和中文文件， 否则会解压出错！！！


## 配置说明

添加新版本，会将旧版本设置为已停用状态， 所以对于每个模块，都只会有一个启用中的版本。

####  版本号

相当于 buildNum , 且每次只能增加， 而 APP下载满足条件的最高版本的包。

#### APP版本号

限定从指定 APP版本号开始 ， 可以使用该离线包。

#### 更新时机

首先，对于离线包检测更新的时机是固定的， 启动时， 以及进入前台间隔10分钟。 

更新时机指定的是 当APP检测到某个模块有新版本时， 合适进行包的下载。暂时有3个选项 ：

* 立即更新 ： 即检测到需要更新时， 立即下载。
* 按需更新 ： 即真正使用到该模块时， 才会下载。
* WIFI时更新 ： 检测时， 如果网络是WIFI状况， 或者 网络变更为WIFI状况时开始下载。 但是 使用模块时，及时没有WIFI也会下载。

默认选项为 WIFI时下载 。 

#### 强制更新

指当使用模块时， 是否弹出弹框，以进行离线包的更新。  

* 强制更新 ： 目的是确保模块每次运行时，都能保持最新版本。
* 静默更新 ： 会使用旧版本的内容， 但是后台会进行下载更新。  如果当前模块本地没有旧版本， 还是会弹出弹框以下载离线包的。

默认选项是 强制更新， 保持离线包版本最新， 是很重要的。

#### tag

标签，用于继续细分一个模块的不同包。 如果设置了`tag` ,则 前端也要设定相应的`tag`, 才能下载该模块。

主要用于 灰度测试 或者 AB测试， 即一个模块有两个不同版本， 根据业务需求，下发不同的版本给不同的用户。

> 只能设置一个`tag`  。 做AB测试时， 必须对命中与不命中的版本都设置`tag` , 如我们设置一个tag 叫做 `hit` ， 以使用离线包的 11版本， 则对于正常 10版本的离线包上也要设置一个`tag` ,如设置为 `unhit`.

默认为 空， 即不设置规则。

## TODO

* 优化 tags 功能
* 添加 模块 关闭功能